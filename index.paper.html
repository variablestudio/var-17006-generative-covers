<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Otwórz ksiązkę</title>
<style type="text/css">
body {
  background: rgb(150, 150, 150)
}

#canvasContainer {
  position: absolute;
  top: 50%;
  left: 50%;
}

#cover {
  background: rgba(255, 255, 255, 1);
  margin: 0 auto;
  display: block;
  margin-top: -300px;
  margin-left: -225px;
  box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.2);
}

canvas {
  background: rgba(255, 255, 255, 1);
}
</style>
<script type="text/javascript" src="js/paper.js"></script>
<script type="text/javascript" src="js/CSVToArray.js"></script>
<script type="text/javascript" src="js/chroma.js"></script>
<script type="text/javascript" src="js/ok.data.js"></script>
<script type="text/paperscript" canvas="cover">

  var books = [];
  var numSourcesLoaded = 0;

  function onBooksLoaded(loadedBooks) {
    books = books.concat(loadedBooks);
    if (++numSourcesLoaded == 2) {
      console.log(books.length);
      makeCovers();
    }
  }

  OK.Data.fromCSV("data/okladki.csv", onBooksLoaded);
  OK.Data.fromJSON("data/books.json", onBooksLoaded);

  function makeCovers() {
    var i = 0;
    function nextCover() {
      makeCover(books[i]);
      i = (i + 1) % books.length;

      setTimeout(nextCover, 1000);
    }

    nextCover();
  }

  function clear() {
    project.activeLayer.remove();
    var layer = new Layer();
  }

  function formatAuthorName(name) {
    var tokens = name.split(', ');
    if (tokens.length == 2)
      return tokens[1] + ' ' + tokens[0];
    else
      return tokens[0];
  }

  function makeElem(type, attribs) {
    attribs = attribs || {};
    var elem = document.createElement(type);
    for(var i in attribs) {
      elem[i] = attribs[i];
    }
    return elem;
  }

  function makeCanvas(attribs) {
    var canvas = makeElem("canvas", attribs);
    return canvas;
  }

  function makeImg(attribs) {
    return makeElem("img", attribs);
  }

  function makeDiv(attribs) {
    return makeElem("div", attribs);
  }

  function makeText(text) {
    return document.createTextNode(text);
  }

  var measureText = (function() {
    var measureTextCanvas = document.createElement("canvas");
    var measureTextContext = measureTextCanvas.getContext('2d');
    return function(text, font, fontSize) {
      measureTextContext.font = fontSize + "pt " + font;

      measureTextContext.fillStyle = "#fF0000";

      var width = measureTextContext.measureText(text).width;
      var height = fontSize;
      return {
        width: width,
        height: height
      }
    };
  })();

  function measureTextObj(textObj) {
    return measureText(textObj.content, textObj.characterStyle.font, textObj.characterStyle.fontSize);
  }

  function makeCover(book) {
    var author = book.author;
    var title = book.title;
    clear();

    var niceBlue = "#27D1E7";
    var paleYellow = "rgb(255, 255, 240)";

    var colorHSL = chroma.hex(niceBlue).hsl();
    niceBlue = chroma.hsl(Math.random() * 255, 0.3, colorHSL[2]).hex();

    var margins = 0;
    var rect = new Path.Rectangle(new Point(margins,margins), view.size - new Size(2 * margins, 2 * margins));
    rect.fillColor = niceBlue;

    var path = new Path();
    path.strokeColor = '#FFF';
    var start = new Point(view.size.width/2, 0);
    path.moveTo(start);
    path.lineTo([0, view.size.width/2]);

    var authorFontSize = view.size.height * 0.03;
    var titleFontSize = view.size.height * 0.06;

    var authorText = new PointText(new Point(50, 100));
    authorText.justification = "left";
    authorText.content = formatAuthorName(author);
    authorText.characterStyle = {
      fontFamily: "Arial",
      fontSize: authorFontSize,
      fillColor: paleYellow
    };

    function breakText(text, font, fontSize, maxWidth) {
      var words = text.split(" ");
      var lines = [];
      var currentLine = "";
      while(words.length > 0) {
        var word = words.shift();
        var newLine = currentLine;
        if (newLine.length > 0) newLine += " ";
        newLine += word;
        var measurements = measureText(newLine, font, fontSize);
        if (measurements.width > maxWidth) {
          lines.push(currentLine);
          currentLine = word;
        }
        else {
          currentLine = newLine;
        }
      }
      lines.push(currentLine);
      return lines;
    }

    var titleWordsAnchor = new Point(50, 175);
    var titleWordsLeading = titleFontSize * 0.5;
    var totalTextHeight = view.size.height;
    var maxTextWidth = 0;
    var titleWords;
    var drawDebug = false;

    var numTries = 0;
    while(totalTextHeight > view.size.height/2 && ++numTries < 10) {
      titleFontSize *= 0.9;
      titleWordsLeading = titleFontSize * 0.5;
      titleWords = breakText(title, "Arial", titleFontSize, view.size.width - titleWordsAnchor.x * 2);

      totalTextHeight = 0;
      maxTextWidth = 0;
      titleWords.forEach(function(word, wordIndex) {
        var measurements = measureText(word, "Arial", titleFontSize);
        totalTextHeight += measurements.height + titleWordsLeading;
        maxTextWidth = Math.max(maxTextWidth, measurements.width);
      });
    }

    titleWords.forEach(function(word, wordIndex) {
      var titleText = new PointText(titleWordsAnchor + [0, wordIndex * (titleFontSize + titleWordsLeading)]);
      titleText.justification = "left";
      titleText.content = word;
      titleText.characterStyle = {
        font: "Arial",
        fontSize: titleFontSize,
        fillColor: paleYellow
      };
      var bounds = measureTextObj(titleText);
    });

    if (drawDebug) {
      var textBoundsRect = new Path.Rectangle(titleWordsAnchor - [0, titleFontSize], new Size(maxTextWidth, totalTextHeight));
      textBoundsRect.strokeColor = "#FF0000";
    }

    view.draw();
  }

</script>
</head>
<body>
  <div id="canvasContainer">
    <canvas id="cover" width="450" height="600"></canvas>
  </div>
</body>
</html>